## Goal

The goal of this lab is to pick up custom metrics that we can store in CloudWatch using the CloudWatch agent.
The to log path's we're going to be monitoring are /var/log/messages and /var/log/yum.log. You can review the configuration
fetched dynamically into the ec2 through the cwatch_config.json. We're also going to add this custom CloudWatch agent metric
to our previous dashboard so we can see the difference in detail.

We're going to generate some interesting logs using the *stress* package provided by the EPEL repository.


## Final result

![EC2 Dashboard](https://github.com/dbgoytia/sysops-training/blob/main/1.monitoring-logging-and-remediation/3.cloudwatch-agent/dashboard.png?raw=true)


## Instructions

1. Launch the terraform code in here.

    ```
    # Initialize terraform providers
    $ terraform init
    ```

    ```
    # Create a plan for the lab, validate everything's ok.
    $ terraform plan -out tfplan 
    ```

    ```
    # Launch terraform
    $ terraform apply tfplan
    ```

2. Log in to the instance and verify that the CloudWatch agent is running

    ```
    # Initialize a session using SSM
    aws ssm start session --target <instance-id> --region us-east-1

    # Verify cloudwatch agent status
    $ systemctl status amazon-cloudwatch-agent.service
    ● amazon-cloudwatch-agent.service - Amazon CloudWatch Agent
    Loaded: loaded (/etc/systemd/system/amazon-cloudwatch-agent.service; enabled; vendor preset: disabled)
    Active: active (running) since Mon 2022-02-21 19:38:51 UTC; 1min 26s ago
    Main PID: 6639 (amazon-cloudwat)
    CGroup: /system.slice/amazon-cloudwatch-agent.service
            └─6639 /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent -config /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.toml -envconfig /opt/aws/amazon-cloudwatch-agent/e...
    ```


3. While logged in to the instance, generate some CPU activity to see something interesting using *stress*

    ```
    $ stress --cpu 1
    ```

4. Add the Memory dashboard to CloudWatch

To generate the Dashboard, add a new widget > Line > CWAgent and search for "mem_used_percent".


5. View the logs generated by the /var/log/messages

To view the messages you need to go to the CloudWatch dashboard. Then, under *Logs* go to *LogGroups*.
In there, you will find *messages* and *yum.log* which will save all the output from this logfiles. In a
later lab we will further explore CloudWatch Log Insights so we can query this information.


## To destroy

1. Destroy the terraform code using

```
# Review what you're about to destroy
$ terraform plan -out tfplan -destroy
```

```
# Destroy the resources
$ terraform apply tfplan
```


## Cool things I've noted

* Visualizing data exported from the CloudWatch Agent in a CloudWatch Dashboard reuqires more data than default values,
so this will highly depend on the outputs provided by your Terraform modules.
* Data inside the logs can easily be queried using CloudWatch Log Insights.


